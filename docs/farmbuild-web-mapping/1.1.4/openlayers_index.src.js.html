<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>openlayers/index.src.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="webmapping.html">webmapping</a><ul class='methods'><li data-type='method'><a href="webmapping.html#.create">create</a></li><li data-type='method'><a href="webmapping.html#.export">export</a></li><li data-type='method'><a href="webmapping.html#.exportGeoJson">exportGeoJson</a></li><li data-type='method'><a href="webmapping.html#.exportKml">exportKml</a></li><li data-type='method'><a href="webmapping.html#.find">find</a></li><li data-type='method'><a href="webmapping.html#.load">load</a></li><li data-type='method'><a href="webmapping.html#.on">on</a></li><li data-type='method'><a href="webmapping.html#.print">print</a></li><li data-type='method'><a href="webmapping.html#.save">save</a></li><li data-type='method'><a href="webmapping.html#.toGeoJson">toGeoJson</a></li><li data-type='method'><a href="webmapping.html#.toKml">toKml</a></li><li data-type='method'><a href="webmapping.html#.update">update</a></li></ul></li><li><a href="webmapping.actions.html">actions</a><ul class='methods'><li data-type='method'><a href="webmapping.actions.html#.destroy">destroy</a></li><li data-type='method'><a href="webmapping.actions.html#.init">init</a></li></ul></li><li><a href="webmapping.actions.donut.html">donut</a><ul class='methods'><li data-type='method'><a href="webmapping.actions.donut.html#.enable">enable</a></li></ul></li><li><a href="webmapping.actions.drawing.html">drawing</a><ul class='methods'><li data-type='method'><a href="webmapping.actions.drawing.html#.discard">discard</a></li><li data-type='method'><a href="webmapping.actions.drawing.html#.enable">enable</a></li><li data-type='method'><a href="webmapping.actions.drawing.html#.finish">finish</a></li><li data-type='method'><a href="webmapping.actions.drawing.html#.isDrawing">isDrawing</a></li></ul></li><li><a href="webmapping.actions.editing.html">editing</a><ul class='methods'><li data-type='method'><a href="webmapping.actions.editing.html#.enable">enable</a></li><li data-type='method'><a href="webmapping.actions.editing.html#.isEditing">isEditing</a></li></ul></li><li><a href="webmapping.actions.features.html">features</a><ul class='methods'><li data-type='method'><a href="webmapping.actions.features.html#.clip">clip</a></li><li data-type='method'><a href="webmapping.actions.features.html#.remove">remove</a></li><li data-type='method'><a href="webmapping.actions.features.html#.selections">selections</a></li></ul></li><li><a href="webmapping.actions.snapping.html">snapping</a><ul class='methods'><li data-type='method'><a href="webmapping.actions.snapping.html#.active">active</a></li><li data-type='method'><a href="webmapping.actions.snapping.html#.disable">disable</a></li><li data-type='method'><a href="webmapping.actions.snapping.html#.enable">enable</a></li></ul></li><li><a href="webmapping.events.html">events</a><ul class='methods'><li data-type='method'><a href="webmapping.events.html#.web-mapping-base-layer-change">web-mapping-base-layer-change</a></li><li data-type='method'><a href="webmapping.events.html#.web-mapping-donut-draw-end">web-mapping-donut-draw-end</a></li><li data-type='method'><a href="webmapping.events.html#.web-mapping-draw-end">web-mapping-draw-end</a></li><li data-type='method'><a href="webmapping.events.html#.web-mapping-feature-deselect">web-mapping-feature-deselect</a></li><li data-type='method'><a href="webmapping.events.html#.web-mapping-feature-select">web-mapping-feature-select</a></li><li data-type='method'><a href="webmapping.events.html#.web-mapping-measure-end">web-mapping-measure-end</a></li></ul></li><li><a href="webmapping.ga.html">ga</a><ul class='methods'><li data-type='method'><a href="webmapping.ga.html#.trackWebMapping">trackWebMapping</a></li></ul></li><li><a href="webmapping.measurement.html">measurement</a><ul class='methods'><li data-type='method'><a href="webmapping.measurement.html#.area">area</a></li><li data-type='method'><a href="webmapping.measurement.html#.length">length</a></li></ul></li><li><a href="webmapping.olHelper.html">olHelper</a><ul class='methods'><li data-type='method'><a href="webmapping.olHelper.html#.center">center</a></li><li data-type='method'><a href="webmapping.olHelper.html#.createBaseLayers">createBaseLayers</a></li><li data-type='method'><a href="webmapping.olHelper.html#.createBaseLayersWithGoogleMaps">createBaseLayersWithGoogleMaps</a></li><li data-type='method'><a href="webmapping.olHelper.html#.createFarmLayers">createFarmLayers</a></li><li data-type='method'><a href="webmapping.olHelper.html#.exportGeometry">exportGeometry</a></li><li data-type='method'><a href="webmapping.olHelper.html#.farmLayer">farmLayer</a></li><li data-type='method'><a href="webmapping.olHelper.html#.farmLayerGroup">farmLayerGroup</a></li><li data-type='method'><a href="webmapping.olHelper.html#.init">init</a></li><li data-type='method'><a href="webmapping.olHelper.html#.initGoogleAddressSearch">initGoogleAddressSearch</a></li><li data-type='method'><a href="webmapping.olHelper.html#.initWithGoogleMap">initWithGoogleMap</a></li><li data-type='method'><a href="webmapping.olHelper.html#.paddocksLayer">paddocksLayer</a></li><li data-type='method'><a href="webmapping.olHelper.html#.reload">reload</a></li><li data-type='method'><a href="webmapping.olHelper.html#.updateExtent">updateExtent</a></li></ul></li><li><a href="webmapping.paddocks.html">paddocks</a><ul class='methods'><li data-type='method'><a href="webmapping.paddocks.html#.findByCoordinate">findByCoordinate</a></li></ul></li><li><a href="webmapping.paddocks_groups.html">paddocks/groups</a><ul class='methods'><li data-type='method'><a href="webmapping.paddocks_groups.html#.add">add</a></li><li data-type='method'><a href="webmapping.paddocks_groups.html#.at">at</a></li><li data-type='method'><a href="webmapping.paddocks_groups.html#.load">load</a></li><li data-type='method'><a href="webmapping.paddocks_groups.html#.removeAt">removeAt</a></li><li data-type='method'><a href="webmapping.paddocks_groups.html#.toArray">toArray</a></li></ul></li><li><a href="webmapping.paddocks_types.html">paddocks/types</a><ul class='methods'><li data-type='method'><a href="webmapping.paddocks_types.html#.add">add</a></li><li data-type='method'><a href="webmapping.paddocks_types.html#.at">at</a></li><li data-type='method'><a href="webmapping.paddocks_types.html#.load">load</a></li><li data-type='method'><a href="webmapping.paddocks_types.html#.removeAt">removeAt</a></li><li data-type='method'><a href="webmapping.paddocks_types.html#.toArray">toArray</a></li></ul></li><li><a href="webmapping.parcels.html">parcels</a><ul class='methods'><li data-type='method'><a href="webmapping.parcels.html#.load">load</a></li></ul></li><li><a href="webmapping.printer.html">printer</a><ul class='methods'><li data-type='method'><a href="webmapping.printer.html#.baseLayers">baseLayers</a></li><li data-type='method'><a href="webmapping.printer.html#.print">print</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">openlayers/index.src.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

/**
 * webmapping openlayers helper
 * @type {object}
 * @namespace webmapping.olHelper
 */

angular.module('farmbuild.webmapping')
    .factory('webMappingOpenLayersHelper',
    function (validations,
              webMappingMeasureControl,
              webMappingSnapControl,
              webMappingGoogleAddressSearch,
              webMappingLayerSwitcherControl,
              webMappingTransformation,
              webMappingConverter,
              $log) {
        var _isDefined = validations.isDefined,
            _googleProjection = 'EPSG:3857',
            _openlayersDefaultProjection = 'EPSG:4326',
            _ZoomToExtentControl,
            _transform = webMappingTransformation,
            _converter = webMappingConverter;

        function addControlsToGmap(gmap, targetElement) {
            gmap.controls[google.maps.ControlPosition.TOP_LEFT].push(targetElement);
            targetElement.parentNode.removeChild(targetElement);
        }

        function addControlsToOlMap(map, extent) {
            if (extent) {
                _ZoomToExtentControl = new ol.control.ZoomToExtent({
                    extent: extent
                });
                map.addControl(_ZoomToExtentControl);
            }
            map.addControl(new ol.control.ScaleLine());
            map.addControl(new webMappingMeasureControl.create(map, 'Polygon'));
            map.addControl(new webMappingMeasureControl.create(map, 'LineString'));
            map.addControl(new webMappingSnapControl.create());
            map.addControl(new ol.control.LayerSwitcher({
                tipLabel: 'Switch on/off farm layers'
            }));
        }

        /**
         * initialise webmapping and integrate with google maps
         * @method initWithGoogleMap
         * @param {!ol.Map} map openlayers map object
         * @param {!ol.Extent} extent - extent of the farm to initialise the map
         * @param {!object} gmap - google map object to integarte with
         * @param {!object} targetElement - openlayers map html element
         * @memberof webmapping.olHelper
         */
        function _initWithGoogleMap(map, extent, gmap, targetElement) {
            if (!_isDefined(gmap) || !_isDefined(map)) {
                return;
            }
            $log.info('integrating google map ...');
            var view = map.getView();
            view.on('change:center', function () {
                var center = ol.proj.transform(view.getCenter(), _googleProjection, _openlayersDefaultProjection);
                gmap.setCenter(new google.maps.LatLng(center[1], center[0]));
            });

            view.on('change:resolution', function () {
                gmap.setZoom(view.getZoom());
            });

            // Google Map and vector layers go out of sync when window is resized.
            window.onresize = function () {
                var center = _transform.toGoogleLatLng(view.getCenter(), _openlayersDefaultProjection);
                google.maps.event.trigger(gmap, "resize");
                gmap.setCenter(center);
            };
            _init(map, extent);
            addControlsToGmap(gmap, targetElement);
        };

        /**
         * initialise webmapping
         * @method init
         * @param {!ol.Map} map openlayers map object
         * @param {!ol.Extent} extent - extent of the farm to initialise the map
         * @memberof webmapping.olHelper
         */
        function _init(map, extent) {
            var defaults = {
                centerNew: [-36.22488327137526, 145.5826132801325],
                zoomNew: 6
            };
            var view = map.getView();
            $log.info('farm extent: %j', extent);

            if (extent[0] === Infinity) {
                view.setCenter(ol.proj.transform([defaults.centerNew[1], defaults.centerNew[0]],
                    'EPSG:4283', _googleProjection));
                view.setZoom(defaults.zoomNew);
            } else {
                view.fitExtent(extent, map.getSize());
            }
            addControlsToOlMap(map, extent);
        }

        /**
         * Exports farm geometry
         * @method exportGeometry
         * @returns {object} object containing farm and paddocks geometry
         * @param {!ol.source.Vector} source openlayers map object
         * @param {!string} dataProjection - data projection code
         * @memberof webmapping.olHelper
         */
        function _exportGeometry(source, dataProjection) {
            if (!_isDefined(source)) {
                return;
            }
            var format = new ol.format['GeoJSON']();
            try {
                var result = format.writeFeaturesObject(source.getFeatures(), {
                        dataProjection: dataProjection,
                        featureProjection: _googleProjection
                    });
                angular.forEach(result.features, function (feature) {
                    feature.geometry.crs = {
                        properties: {
                            name: dataProjection
                        }
                    }
                });
                return result;
            } catch (e) {
                $log.error(e);
            }
        };

        /**
         * Centers map at the specified coordinates and set zoom to a proper level
         * @method center
         * @param {!ol.Coordinate} coordinates
         * @param {!ol.Map} map object to interact with
         * @memberof webmapping.olHelper
         */
        function _center(coordinates, map) {
            if (!_isDefined(coordinates) || !_isDefined(map)) {
                return;
            }
            $log.info('centring view ...');
            map.getView().setCenter(coordinates);
            map.getView().setZoom(15);
        };

        function _createPaddocksLayer(paddocksGeometry, dataProjection) {
            if (!_isDefined(paddocksGeometry) || !_isDefined(dataProjection)) {
                return;
            }
            $log.info('creating paddocks vector layer ...', dataProjection, _googleProjection);
            var paddocksSource = new ol.source.Vector({
                features: (new ol.format.GeoJSON()).readFeatures(paddocksGeometry, {
                    dataProjection: dataProjection,
                    featureProjection: _googleProjection
                })
            });

            return new ol.layer.Vector({
                source: paddocksSource,
                title: 'Paddocks',
                style: new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 255, 255, 0.3)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#319FD3',
                        width: 1
                    })
                })
            });
        };

        function _createFarmLayer(farmGeometry, dataProjection) {
            if (!_isDefined(farmGeometry) || !_isDefined(dataProjection)) {
                return;
            }
            $log.info('creating farm vector layer ...', dataProjection, _googleProjection);
            var farmSource = new ol.source.Vector({
                features: (new ol.format.GeoJSON()).readFeatures(farmGeometry, {
                    dataProjection: dataProjection,
                    featureProjection: _googleProjection
                })
            });

            return new ol.layer.Vector({
                source: farmSource,
                title: 'Farm',
                style: new ol.style.Style({
                    fill: new ol.style.Fill({
                        color: 'rgba(255, 255, 255, 0)'
                    }),
                    stroke: new ol.style.Stroke({
                        color: '#ff6600',
                        width: 3
                    })
                })
            });
        };

        /**
         * Creates farm layerGroup
         * @method createFarmLayers
         * @returns {ol.layer.Group} object containing farm and paddocks geometry
         * @param {!object} geometry farmGeometry
         * @param {!string} dataProjection - data projection code
         * @param {!string} featureProjection - feature projection code
         * @memberof webmapping.olHelper
         */
        function _createFarmLayers(geometry, dataProjection, featureProjection) {
            return new ol.layer.Group({
                'title': 'Farm layers',
                layers: [
                    _createPaddocksLayer(geometry.paddocks, dataProjection, featureProjection),
                    _createFarmLayer(geometry.farm, dataProjection, featureProjection)
                ]
            })
        }

        /**
         * Creates base layers layerGroup - to get base layers with google map layers use: createBaseLayersWithGoogleMaps
         * @method createBaseLayers
         * @returns {ol.layer.Group} object containing farm and paddocks geometry
         * @memberof webmapping.olHelper
         */
        function _createBaseLayers() {
            var vicMapImageryLayer = new ol.layer.Tile({
                    title: 'VicMAP Imagery',
                    type: 'base',
                    visible: true,
                    source: new ol.source.TileWMS({
                        url: 'http://api.maps.vic.gov.au/vicmapapi-mercator/map-wm/wms',
                        params: {LAYERS: 'SATELLITE_WM', VERSION: '1.1.1'}
                    })
                }),
                vicMapStreetLayer = new ol.layer.Tile({
                    title: 'VicMAP Street',
                    type: 'base',
                    visible: false,
                    source: new ol.source.TileWMS({
                        url: 'http://api.maps.vic.gov.au/vicmapapi-mercator/map-wm/wms',
                        params: {LAYERS: 'WEB_MERCATOR', VERSION: '1.1.1'}
                    })
                });

            return new ol.layer.Group({
                'title': 'Base maps',
                layers: [vicMapImageryLayer, vicMapStreetLayer]
            })
        };

        /**
         * Creates base layers layerGroup - to get base layers without google map layers use: createBaseLayers
         * @method createBaseLayersWithGoogleMaps
         * @returns {ol.layer.Group} object containing farm and paddocks geometry
         * @memberof webmapping.olHelper
         */
        function _createBaseLayersWithGoogleMaps() {
            var vicMapImageryLayer = new ol.layer.Tile({
                    title: 'VicMAP Imagery',
                    type: 'base',
                    visible: false,
                    source: new ol.source.TileWMS({
                        url: 'http://api.maps.vic.gov.au/vicmapapi-mercator/map-wm/wms',
                        params: {LAYERS: 'SATELLITE_WM', VERSION: '1.1.1'}
                    })
                }),
                vicMapStreetLayer = new ol.layer.Tile({
                    title: 'VicMAP Street',
                    type: 'base',
                    visible: false,
                    source: new ol.source.TileWMS({
                        url: 'http://api.maps.vic.gov.au/vicmapapi-mercator/map-wm/wms',
                        params: {LAYERS: 'WEB_MERCATOR', VERSION: '1.1.1'}
                    })
                }),
                googleImageryLayer = new ol.layer.Tile({
                    title: 'Google Imagery',
                    type: 'base',
                    visible: true
                }),
                googleStreetLayer = new ol.layer.Tile({
                    title: 'Google Street',
                    type: 'base',
                    visible: false
                });

            return new ol.layer.Group({
                'title': 'Base maps',
                layers: [vicMapImageryLayer, vicMapStreetLayer, googleStreetLayer, googleImageryLayer]
            })
        };

        /**
         * Reloads the farm layers
         * @method reload
         * @param {!ol.Map} map openlayers map object
         * @param {!object} geoJsons object that containts farm and paddocks geometry to reload from
         * @param {!string} dataProjection - data projection code
         * @memberof webmapping.olHelper
         */
        function _reload(map, geoJsons, dataProjection) {
            var farmLayers = map.getLayers().item(1).getLayers(),
                farmSource = farmLayers.item(1).getSource(),
                paddocksSource = farmLayers.item(0).getSource(),
                farmFeatures = _converter.geoJsonToFeatures(geoJsons.farm, dataProjection, _googleProjection),
                paddockFeatures = _converter.geoJsonToFeatures(geoJsons.paddocks, dataProjection, _googleProjection);
            farmSource.clear();
            paddocksSource.clear();
            farmSource.addFeatures(farmFeatures);
            paddocksSource.addFeatures(paddockFeatures);
        };

        /**
         * Initialises google address search and creates a autocomplete for given text input.
         * @method initGoogleAddressSearch
         * @param {!object} textInputElement Text input dom element which is used to show autocomplete
         * @param {!ol.Map} olmap object to interact with when user chooses a location from autocomplete
         * @memberof webmapping.olHelper
         */
        function _initGoogleAddressSearch(textInputElement, olmap) {
            if (!_isDefined(textInputElement) || !_isDefined(olmap)) {
                return;
            }
            $log.info('init google address search ...', textInputElement);
            function onPlaceChanged(latLng) {
                latLng = _transform.fromGoogleLatLng(latLng);
                _center(latLng, olmap);
            }

            webMappingGoogleAddressSearch.init(textInputElement, onPlaceChanged);
        };

        /**
         * Updates the extent of ZoomToExtent control, call this method after a change to farm boundaries.
         * @method updateExtent
         * @memberof webmapping.olHelper
         */
        function _updateZoomToExtent() {
            var map;
            if (!_isDefined(_ZoomToExtentControl)) {
                return;
            }
            map = _ZoomToExtentControl.getMap();
            map.removeControl(_ZoomToExtentControl);
            _ZoomToExtentControl = new ol.control.ZoomToExtent({
                extent: map.getLayers().item(1).getLayers().item(1).getSource().getExtent()
            });
            map.addControl(_ZoomToExtentControl);
        };

        /**
         * Returns farm layer from passed map
         * @method farmLayer
         * @param {!ol.Map} map object with farm layers and base layers
         * @returns {ol.layer.Vector} farm Layer
         * @memberof webmapping.olHelper
         */
        function _farmLayer(map) {
            if (!_isDefined(map) || !_isDefined(map.getLayers().item(1)) || !_isDefined(map.getLayers().item(1).getLayers() || !_isDefined(map.getLayers().item(1).getLayers().getLength() === 2))) {
                return;
            }
            return map.getLayers().item(1).getLayers().item(1);
        };

        /**
         * Returns paddocks layer from passed map
         * @method paddocksLayer
         * @param {!ol.Map} map object with farm layers and base layers
         * @returns {ol.layer.Vector} paddocks Layer
         * @memberof webmapping.olHelper
         */
        function _paddocksLayer(map) {
            if (!_isDefined(map) || !_isDefined(map.getLayers().item(1)) || !_isDefined(map.getLayers().item(1).getLayers() || !_isDefined(map.getLayers().item(1).getLayers().getLength() === 2))) {
                return;
            }
            return map.getLayers().item(1).getLayers().item(0);
        };

        /**
         * Returns farm layer group from passed map, this group contains farm and paddocks vector layers
         * @method farmLayerGroup
         * @param {!ol.Map} map object with farm layers and base layers
         * @returns {ol.layer.Group} farm Layer Group
         * @memberof webmapping.olHelper
         */
        function _farmLayerGroup(map) {
            if (!_isDefined(map) || !_isDefined(map.getLayers().item(1))) {
                return;
            }
            return map.getLayers().item(1);
        };

        return {
            init: _init,
            exportGeometry: _exportGeometry,
            center: _center,
            initWithGoogleMap: _initWithGoogleMap,
            createFarmLayers: _createFarmLayers,
            createBaseLayers: _createBaseLayers,
            createBaseLayersWithGoogleMaps: _createBaseLayersWithGoogleMaps,
            farmLayer: _farmLayer,
            paddocksLayer: _paddocksLayer,
            farmLayerGroup: _farmLayerGroup,
            reload: _reload,
            initGoogleAddressSearch: _initGoogleAddressSearch,
            updateExtent: _updateZoomToExtent
        }

    });
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Mon Oct 03 2016 10:17:39 GMT+1100 (AEDT) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
