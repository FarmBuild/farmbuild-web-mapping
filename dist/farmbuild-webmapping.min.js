"use strict";angular.module("farmbuild.webmapping",["farmbuild.core","farmbuild.farmdata"]).factory("webmapping",function(farmdata,validations,$log,webmappingValidator,webmappingConverter,webMappingSession,webMappingProjections,webMappingInteractions,webMappingPaddocks,webMappingOpenLayersHelper,webMappingGoogleAddressSearch){$log.info("Welcome to Web Mapping...");var session=(validations.isDefined,webMappingSession),webMapping={session:session,farmdata:farmdata,validator:webmappingValidator,toGeoJsons:webmappingConverter.toGeoJsons,actions:webMappingInteractions,paddocks:webMappingPaddocks,olHelper:webMappingOpenLayersHelper,googleAddressSearch:webMappingGoogleAddressSearch,load:session.load,find:session.find,save:function(geoJsons){var farmData=session.find();return session.save(webmappingConverter.toFarmData(farmData,geoJsons))},"export":session["export"],create:farmdata.create};return webMapping.version="0.1.0","undefined"==typeof window.farmbuild?window.farmbuild={webmapping:webMapping}:window.farmbuild.webmapping=webMapping,webMapping}),angular.module("farmbuild.webmapping").factory("webmappingConverter",function(farmdata,validations,$log,webmappingValidator,webMappingSession){function convertCrs(geometry,crs){return geometry.crs={type:"name",properties:{name:crs}},geometry}function resetCrs(geometry){return geometry.crs=geometry.crs.properties.name,geometry}function createFeature(geometry,crs,name){return{type:"Feature",geometry:angular.copy(convertCrs(geometry,crs)),properties:{name:name}}}function toGeoJsons(farmData){$log.info("Extracting farm and paddocks geometry from farmData ...");var copied=angular.copy(farmData);if(!validator.validate(copied))return void 0;var farm=copied.geometry,paddocks=[];return copied.paddocks.forEach(function(paddock){paddocks.push(createFeature(paddock.geometry,farm.crs,paddock.name))}),{farm:{type:"FeatureCollection",features:[createFeature(farm,farm.crs,copied.name)]},paddocks:{type:"FeatureCollection",features:paddocks}}}function toFarmData(farmData,geoJsons){$log.info("Converting geoJsons.farm.features[0] and paddocks geojson to farmData ...");var farmFeature=geoJsons.farm.features[0],paddocks=geoJsons.paddocks;return farmData.geometry=resetCrs(farmFeature.geometry),paddocks.features.forEach(function(paddockFeature,i){farmData.paddocks[i].geometry=paddockFeature.geometry,delete farmData.paddocks[i].geometry.crs}),farmData}var webmappingConverter=(validations.isDefined,{}),validator=webmappingValidator;return webmappingConverter.toGeoJsons=toGeoJsons,webmappingConverter.toFarmData=toFarmData,webmappingConverter}),angular.module("farmbuild.webmapping").factory("webMappingDrawInteraction",function(validations,$log){function _create(map,farmSource,paddocksSource){function _init(clipFn,selectInteraction){$log.info("draw interaction init ..."),map.addInteraction(drawInteraction),drawInteraction.setActive(!1),drawInteraction.on("drawend",function(e){$log.info("draw end ...");var feature=e.feature;feature.setProperties({name:"parham"}),clipFn(feature,paddocksSource,farmSource),setTimeout(function(){paddocksSource.removeFeature(feature)},100),drawingStatus=!1}),drawInteraction.on("drawstart",function(event){$log.info("draw start ..."),selectInteraction.interaction.getFeatures().clear(),drawingStatus=!0})}function _enable(){drawInteraction.setActive(!0)}function _disable(){drawInteraction.setActive(!1)}function _finish(){drawInteraction.finishDrawing()}function _isDrawing(){return drawingStatus}var drawInteraction=new ol.interaction.Draw({source:paddocksSource,type:"Polygon"}),drawingStatus=!1;return{init:_init,enable:_enable,disable:_disable,interaction:drawInteraction,isDrawing:_isDrawing,finish:_finish}}validations.isDefined;return{create:_create}}),angular.module("farmbuild.webmapping").factory("webMappingInteractions",function(validations,$log,webMappingSelectInteraction,webMappingModifyInteraction,webMappingDrawInteraction,webMappingSnapInteraction,webMappingTransformations){function _destroy(map){$log.info("destroying all interactions ..."),map.getInteractions().clear(),map.addInteraction(new ol.interaction.DragPan({kinetic:null})),_select=void 0,_modify=void 0,_draw=void 0,_snap=void 0,_activeLayer=void 0,_activeLayerName=void 0,_mode=void 0}function _init(map,farmLayer,paddocksLayer,activeLayerName,multi){if($log.info("interactions init ..."),_isDefined(activeLayerName)&&_isDefined(map)&&_isDefined(paddocksLayer)&&_isDefined(farmLayer)){if("paddocks"===activeLayerName)_activeLayer=paddocksLayer;else{if("farm"!==activeLayerName)return;_activeLayer=farmLayer}_select=webMappingSelectInteraction.create(map,_activeLayer,multi),_modify=webMappingModifyInteraction.create(map,_select),_draw=webMappingDrawInteraction.create(map,farmLayer.getSource(),paddocksLayer.getSource()),_snap=webMappingSnapInteraction.create(map,farmLayer.getSource(),paddocksLayer.getSource()),_mode="",_activeLayerName=activeLayerName,_select.init(),_modify.init(),_draw.init(_clip,_select),_snap.init()}}function _addGeoJsonFeature(layer,feature,name){_isDefined(feature)&&($log.info("adding feature ...",feature),layer.getSource().addFeature(new ol.Feature({geometry:new ol.geom[feature.geometry.type](feature.geometry.coordinates),name:name})),_clearSelections())}function _remove(features,deselect){_isDefined(deselect)||(deselect=!0),$log.info("removing features ...",features),_isDefined(features)&&features.forEach(function(feature){_activeLayer.getSource().removeFeature(feature)}),deselect&&_clearSelections()}function _clip(featureToClip,paddockSource,farmSource){$log.info("clipping feature ...",featureToClip),"paddocks"!==_activeLayerName||"draw"!==_mode&&"edit"!==_mode||_clipPaddocks(featureToClip,paddockSource,farmSource),"paddocks"===_activeLayerName&&"donut-draw"===_mode&&_clipDonut(featureToClip),"farm"===_activeLayerName&&_clipFarm(featureToClip,farmSource)}function _clipPaddocks(featureToClip,paddockSource,farmSource){var clipped,paddocksFeatures=paddockSource.getFeatures(),farmFeatures=farmSource.getFeatures(),name=featureToClip.getProperties().name;clipped=transform.erase(featureToClip,paddocksFeatures),clipped=transform.intersect(new ol.Feature({geometry:new ol.geom[clipped.geometry.type](clipped.geometry.coordinates)}),farmFeatures),_addGeoJsonFeature(_activeLayer,clipped,name)}function _clipDonut(donutFeature){var clipped,paddockFeature=_activeLayer.getSource().getFeaturesAtCoordinate(donutFeature.geometry.coordinates[0][1])[0],name=donutFeature.getProperties().name;clipped=turf.erase(paddockFeature,donutFeature),_addGeoJsonFeature(_activeLayer,clipped,name),_activeLayer.getSource().removeFeature(paddockFeature)}function _clipFarm(featureToClip,farmSource){var farmFeatures=farmSource.getFeatures(),clipped=transform.erase(featureToClip,farmFeatures),name=featureToClip.getProperties().name;_addGeoJsonFeature(_activeLayer,clipped),_remove(farmFeatures,!1),clipped=transform.merge(farmSource.getFeatures()),_addGeoJsonFeature(_activeLayer,clipped,name),_clearSelections()}function _merge(features){$log.info("merging features ...",features),_remove(features,!1),_addGeoJsonFeature(_activeLayer,transform.merge(features)),_clearSelections()}function _selectedFeatures(){return _isDefined(_select)&&_isDefined(_select.interaction)?($log.info("Selected features ...",_select.interaction.getFeatures()),_select.interaction.getFeatures()):void 0}function _enableEditing(){-_isDefined(_mode)&&"edit"!==_mode&&($log.info("editing enabled"),_select.enable(),_modify.enable(),_snap.enable(),_draw.disable(),_mode="edit")}function _enableDrawing(){-_isDefined(_mode)&&"draw"!==_mode&&($log.info("drawing enabled"),_select.disable(),_modify.disable(),_draw.enable(),_snap.enable(),_mode="draw")}function _enableDonutDrawing(){-_isDefined(_mode)&&"donut-draw"!==_mode&&($log.info("donut drawing enabled"),_select.disable(),_modify.disable(),_draw.enable(),_snap.enable(),_mode="donut-draw")}function _clearSelections(){_select.interaction.getFeatures().clear()}function _isDrawing(){return-_isDefined(_mode)?_draw.isDrawing():void 0}function _finishDrawing(){-_isDefined(_mode)&&_draw.finish()}function _discardDrawing(){-_isDefined(_mode)&&(_draw.disable(),_draw.enable())}function _isEditing(){return-_isDefined(_mode)?_select.interaction.getFeatures().getLength()>0:void 0}var _select,_modify,_draw,_snap,_activeLayer,_activeLayerName,_mode,_isDefined=validations.isDefined,transform=webMappingTransformations;return{init:_init,destroy:_destroy,enableDrawing:_enableDrawing,enableEditing:_enableEditing,enableDonutDrawing:_enableDonutDrawing,clip:_clip,merge:_merge,remove:_remove,selectedFeatures:_selectedFeatures,isDrawing:_isDrawing,isEditing:_isEditing,finishDrawing:_finishDrawing,discardDrawing:_discardDrawing}}),angular.module("farmbuild.webmapping").factory("webMappingModifyInteraction",function(validations,$log){function _create(map,select){function _init(){$log.info("modify interaction init ..."),map.addInteraction(modifyInteraction),modifyInteraction.setActive(!1)}function _enable(){modifyInteraction.setActive(!0)}function _disable(){modifyInteraction.setActive(!1)}var modifyInteraction=new ol.interaction.Modify({features:select.interaction.getFeatures()});return{init:_init,enable:_enable,disable:_disable,interaction:modifyInteraction}}validations.isDefined;return{create:_create}}),angular.module("farmbuild.webmapping").factory("webMappingSelectInteraction",function(validations,$log){function _create(map,layer,multi){function _init(){$log.info("select interaction init ..."),map.addInteraction(selectInteraction),selectInteraction.setActive(!1)}function _enable(){selectInteraction.setActive(!0)}function _disable(){selectInteraction.setActive(!1)}_isDefined(multi)||(multi=!1);var selectConfig={multi:multi,layers:[layer]};multi?selectConfig.addCondition=ol.events.condition.shiftKeyOnly:(selectConfig.addCondition=ol.events.condition.never,selectConfig.toggleCondition=ol.events.condition.never);var selectInteraction=new ol.interaction.Select(selectConfig);return{init:_init,enable:_enable,disable:_disable,interaction:selectInteraction}}var _isDefined=validations.isDefined;return{create:_create}}),angular.module("farmbuild.webmapping").factory("webMappingSnapInteraction",function(validations,$log){function _create(map,farmSource,paddocksSource){function _enable(){snapInteraction.setActive(!0)}function _disable(){snapInteraction.setActive(!1)}function _init(){$log.info("snap interaction init ..."),map.addInteraction(snapInteraction),snapInteraction.setActive(!1)}var snapInteraction=new ol.interaction.Snap({source:paddocksSource});return snapInteraction.addFeature(farmSource.getFeatures()[0]),{init:_init,enable:_enable,disable:_disable,interaction:snapInteraction}}validations.isDefined;return{create:_create}}),angular.module("farmbuild.webmapping").factory("webMappingMeasurement",function(validations,$log){function _featuresToGeoJson(olFeatures){return angular.fromJson(olFeatures.getArray?_geoJSONFormat.writeFeatures(olFeatures.getArray()):_geoJSONFormat.writeFeatures(olFeatures))}function _area(olFeatures){$log.info("calculating area of features ...",olFeatures);var geoJsonFeatures=_featuresToGeoJson(olFeatures);return 1e-4*turf.area(geoJsonFeatures)}var _geoJSONFormat=(validations.isDefined,new ol.format.GeoJSON);return{area:_area}}),angular.module("farmbuild.webmapping").factory("webMappingOpenLayersHelper",function(validations,$log){function _transform(latLng,sourceProjection,destinationProjection){if(_isDefined(latLng)&&_isDefined(sourceProjection)&&_isDefined(destinationProjection)){var transformed=ol.proj.transform(latLng,sourceProjection,destinationProjection);return new google.maps.LatLng(transformed[1],transformed[0])}}function _exportGeometry(source){if(_isDefined(source)){var format=new ol.format.GeoJSON;try{return format.writeFeatures(source.getFeatures())}catch(e){$log.error(e)}}}function _clear(farmSource,paddocksSource){_isDefined(farmSource)&&_isDefined(paddocksSource)&&($log.info("clearing source ..."),paddocksSource.clear(),farmSource.clear())}function _integrateGMap(gmap,map,dataProjection){if(_isDefined(gmap)&&_isDefined(map)&&_isDefined(dataProjection)){$log.info("integrating google map ...");var view=map.getView(),targetElement=map.getTargetElement(),googleProjection="EPSG:3857";view.on("change:center",function(){var center=ol.proj.transform(view.getCenter(),googleProjection,dataProjection);gmap.setCenter(new google.maps.LatLng(center[1],center[0]))}),view.on("change:resolution",function(){gmap.setZoom(view.getZoom())}),window.onresize=function(){var center=_transform(view.getCenter(),googleProjection,dataProjection);google.maps.event.trigger(gmap,"resize"),gmap.setCenter(center)};var defaults={centerNew:[-36.22488327137526,145.5826132801325],zoomNew:6},extent=map.getLayers().item(1).getSource().getExtent();if($log.info("farm extent: %j",extent),extent[0]===1/0)return gmap.controls[google.maps.ControlPosition.TOP_LEFT].push(targetElement),targetElement.parentNode.removeChild(targetElement),view.setCenter(ol.proj.transform([defaults.centerNew[1],defaults.centerNew[0]],dataProjection,googleProjection)),void view.setZoom(defaults.zoomNew);gmap.controls[google.maps.ControlPosition.TOP_LEFT].push(targetElement),targetElement.parentNode.removeChild(targetElement),view.fitExtent(extent,map.getSize())}}function _center(coordinates,map){_isDefined(coordinates)&&_isDefined(map)&&($log.info("centring view ..."),map.getView().setCenter(coordinates),map.getView().setZoom(15))}function _paddocksLayer(paddocksGeometry,dataProjection,featureProjection){if(_isDefined(paddocksGeometry)&&_isDefined(dataProjection)&&_isDefined(featureProjection)){$log.info("creating paddocks vector layer ...",dataProjection,featureProjection);var paddocksSource=new ol.source.Vector({features:(new ol.format.GeoJSON).readFeatures(paddocksGeometry,{dataProjection:dataProjection,featureProjection:featureProjection})});return new ol.layer.Vector({source:paddocksSource,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.3)"}),stroke:new ol.style.Stroke({color:"#319FD3",width:1})})})}}function _farmLayer(farmGeometry,dataProjection,featureProjection){if(_isDefined(farmGeometry)&&_isDefined(dataProjection)&&_isDefined(featureProjection)){$log.info("creating farm vector layer ...",dataProjection,featureProjection);var farmSource=new ol.source.Vector({features:(new ol.format.GeoJSON).readFeatures(farmGeometry,{dataProjection:dataProjection,featureProjection:featureProjection})});return new ol.layer.Vector({source:farmSource,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0)"}),stroke:new ol.style.Stroke({color:"#ff6600",width:3})})})}}var _isDefined=validations.isDefined;return{exportGeometry:_exportGeometry,clear:_clear,center:_center,integrateGMap:_integrateGMap,paddocksLayer:_paddocksLayer,farmLayer:_farmLayer}}),angular.module("farmbuild.webmapping").factory("webMappingPaddocks",function($log,collections){function _add(){}function _remove(){}function _edit(){}function _find(){}function _validate(){}return{add:_add,remove:_remove,edit:_edit,find:_find,validate:_validate}}),angular.module("farmbuild.webmapping").factory("webMappingProjections",function($log,farmdata){var webMappingProjections={supported:farmbuild.farmdata.crsSupported};return farmbuild.farmdata.crsSupported.forEach(function(crs){proj4.defs(crs.name,crs.projection)}),webMappingProjections}),angular.module("farmbuild.webmapping").factory("webMappingSession",function($log,farmdata,validations){function load(farmData){var loaded=farmdata.load(farmData);return _isDefined(loaded)?farmData:void 0}function save(farmData){return _isDefined(farmData)?farmdata.update(farmData):void $log.error("Unable to save the undefined farmData!")}var webMappingSession={},_isDefined=validations.isDefined;return webMappingSession.load=load,webMappingSession.save=save,webMappingSession.clear=farmdata.session.clear,webMappingSession.isLoadFlagSet=farmdata.session.isLoadFlagSet,webMappingSession.find=function(){return farmdata.session.find()},webMappingSession["export"]=function(document,farmData){return farmdata.session["export"](document,save(farmData))},webMappingSession}),angular.module("farmbuild.webmapping").factory("webMappingTransformations",function(validations,$log){function _featureToGeoJson(olFeature){return angular.fromJson(_geoJSONFormat.writeFeature(olFeature))}function _featuresToGeoJson(olFeatures){return angular.fromJson(olFeatures.getArray?_geoJSONFormat.writeFeatures(olFeatures.getArray()):_geoJSONFormat.writeFeatures(olFeatures))}function _erase(olFeature,olFeatures){var feature=_featureToGeoJson(olFeature);try{return olFeatures.forEach(function(layerFeature){var clipper=_featureToGeoJson(layerFeature);feature=turf.erase(feature,clipper)}),feature}catch(e){$log.error(e)}}function _intersect(olFeature,olFeatures){var feature=_featureToGeoJson(olFeature);try{return olFeatures.forEach(function(layerFeature){var clipper=_featureToGeoJson(layerFeature);feature=turf.intersect(feature,clipper)}),feature}catch(e){$log.error(e)}}function _merge(olFeatures){$log.info("merging features ...",olFeatures);var toMerge;toMerge=_featuresToGeoJson(olFeatures);try{return turf.merge(toMerge)}catch(e){$log.error(e)}}var _geoJSONFormat=(validations.isDefined,new ol.format.GeoJSON);return{erase:_erase,intersect:_intersect,merge:_merge}}),angular.module("farmbuild.webmapping").factory("webmappingValidator",function(validations,farmdata,$log){function isGeoJsons(geoJsons){var errors=geojsonhint.hint("string"==typeof geoJsons?geoJsons:angular.toJson(geoJsons)),isGeoJson=0===errors.length;return isGeoJson||$log.error("isGeoJsons errors: ",errors),isGeoJson}function _validate(farmData){return $log.info("validating farmData...",farmData),farmdata.validate(farmData)?_isDefined(farmData)&&_isDefined(farmData.geometry)&&_isDefined(farmData.geometry.crs)&&_isDefined(farmData.paddocks)?!0:($log.error("farmData must have geometry, geometry.crs, paddocks"),!1):!1}{var webmappingValidator={geojsonhint:geojsonhint},_isDefined=validations.isDefined;validations.isArray,validations.isPositiveNumber,validations.isEmpty}if(!_isDefined(geojsonhint))throw Error("geojsonhint must be available!");return webmappingValidator.isGeoJsons=isGeoJsons,webmappingValidator.validate=_validate,webmappingValidator}),angular.module("farmbuild.webmapping").factory("webMappingGoogleAddressSearch",function(validations,$log,webMappingOpenLayersHelper){function _init(targetElementId,openLayersProjection,olmap){var autocomplete=new google.maps.places.Autocomplete(document.getElementById(targetElementId),{componentRestrictions:countryRestrict});google.maps.event.addListener(autocomplete,"place_changed",function(){_onPlaceChanged(autocomplete,openLayersProjection,olmap)})}function _onPlaceChanged(autocomplete,openLayersProjection,olmap){var latLng,place=autocomplete.getPlace();place.geometry&&(latLng=place.geometry.location,_center(latLng,openLayersProjection,olmap))}function _transform(latLng,sourceProjection,destinationProjection){return ol.proj.transform([latLng.lng(),latLng.lat()],sourceProjection,destinationProjection)}function _center(latLng,openLayersProjection,olmap){var googleMapProjection="EPSG:3857",centerPoint=_transform(latLng,openLayersProjection,googleMapProjection);webMappingOpenLayersHelper.center(centerPoint,olmap)}var countryRestrict={country:"au"};return{init:_init}}),angular.module("farmbuild.webmapping").run(function(webmapping){}),angular.injector(["ng","farmbuild.webmapping"]);
//# sourceMappingURL=farmbuild-webmapping.min.js.map